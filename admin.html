<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin  NhoyHub </title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<header class="bg-white border-b">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="font-bold text-xl"><a href="admin.html">Admin Panel</a></h1>
    <div class="flex items-center gap-3">
      <a href="index.html" class="text-sm text-indigo-600">View Site</a>
      <button id="logout" class="text-sm px-3 py-1 border rounded hover:bg-gray-100">Logout</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-2 sm:px-4 py-8 space-y-8">

  <section class="bg-white border rounded-2xl p-4 sm:p-6 shadow-md">
    <h2 class="font-semibold mb-4 text-lg text-indigo-600">üõ†Ô∏è Global Image Configuration</h2>
    
    <form id="configPublicForm" class="flex flex-col sm:flex-row gap-3 items-end border-b pb-4 mb-4">
      <div class="flex-grow w-full">
        <label for="publicImageUrl" class="text-sm font-medium text-gray-700">Public Order List Image URL (Cart):</label>
        <input name="public_image_url" id="publicImageUrl" class="border rounded px-3 py-2 w-full" placeholder="Paste external image URL here" required>
        <div id="currentCartConfig" class="text-xs text-gray-600"></div>
      </div>
      <button class="bg-green-600 text-white rounded px-4 py-2 w-full sm:w-auto hover:bg-green-700 transition">Save Cart Image</button>
    </form>

    <h3 class="font-semibold text-gray-700 mt-4 mb-3">Esign Detail Image Gallery:</h3>
    <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-5 gap-3" id="esign-image-inputs">
      </div>
    <p id="configMsg" class="text-sm mt-2 font-medium"></p>
  </section>
  <section class="bg-white border rounded-2xl p-4 sm:p-6 shadow-md">
    <h2 class="font-semibold mb-3 text-lg">Add Order</h2>
    <form id="addForm" class="grid gap-3 sm:grid-cols-2 md:grid-cols-4">
      <input name="name" class="border rounded px-3 py-2 w-full" placeholder="Name" required>
      <input name="udid" class="border rounded px-3 py-2 w-full" placeholder="UDID" required>
      <input name="image" type="file" class="border rounded px-3 py-2 w-full" required>
      <button class="bg-indigo-600 text-white rounded px-4 py-2 w-full hover:bg-indigo-700 transition">Add</button>
    </form>
    <p id="addMsg" class="text-sm mt-2"></p>
  </section>

  <section class="bg-white border rounded-2xl p-4 sm:p-6 shadow-md">
    <div class="flex flex-wrap gap-2 items-center">
      <input id="q" class="border rounded px-3 py-2 w-full sm:w-auto" placeholder="Search name or UDID">
      <select id="status" class="border rounded px-3 py-2 w-full sm:w-auto">
        <option value="">All</option><option>pending</option><option>approved</option><option value="rejected">backlist</option>
        </select>
      <button id="btnSearch" class="px-4 py-2 rounded bg-gray-900 text-white w-full sm:w-auto hover:bg-gray-700 transition">Search</button>
      <div class="ml-auto text-sm w-full sm:w-auto text-center sm:text-right pt-2 sm:pt-0" id="meta"></div>
    </div>
  </section>

  <section class="bg-white border rounded-2xl p-4 sm:p-6 shadow-md">
    <div class="overflow-x-auto">
      <table class="w-full text-sm min-w-[950px]">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 text-left">ID</th>
            <th class="p-2 text-left">Image</th>
            <th class="p-2 text-left">Name</th>
            <th class="p-2 text-left">UDID</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">Download Link</th> 
            <th class="p-2 text-left">Payment Link</th> 
            <th class="p-2 text-left">Created</th>
            <th class="p-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="flex items-center justify-center gap-2 mt-4">
      <button id="prev" class="px-3 py-1 border rounded hover:bg-gray-100">Prev</button>
      <span id="pageInfo" class="text-sm"></span>
      <button id="next" class="px-3 py-1 border rounded hover:bg-gray-100">Next</button>
    </div>
  </section>

</main>

<div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-40">
  <div class="bg-white rounded-2xl p-6 w-full max-w-sm sm:max-w-md">
    <h3 class="text-lg font-semibold mb-3">Edit Order</h3>
    <form id="editForm" class="grid gap-3">
      <input type="hidden" name="id">
      <input name="name" class="border rounded px-3 py-2 w-full" placeholder="Name">
      <input name="udid" class="border rounded px-3 py-2 w-full" placeholder="UDID">
      <input name="download_link" class="border rounded px-3 py-2 w-full" placeholder="Esign Download Link" type="url">
      <select name="status" class="border rounded px-3 py-2 w-full">
        <option value="pending">pending</option><option value="approved">approved</option><option value="rejected">backlist</option>
        </select>
      <label class="text-sm">Replace Image (optional)</label>
      <input name="image" type="file" class="border rounded px-3 py-2 w-full">
      <div class="flex justify-end gap-2 pt-3">
        <button type="button" id="closeModal" class="px-3 py-2 border rounded hover:bg-gray-100">Cancel</button>
        <button class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Save</button>
      </div>
    </form>
    <p id="editMsg" class="text-sm mt-2"></p>
  </div>
</div>

<script>
const API = "http://127.0.0.1:8000";
let page = 1, pageSize = 12, total = 0;

function token() { return localStorage.getItem("admin_token") || ""; }
function authHeaders() { return { "Authorization": "Bearer " + token() }; }
function ensureLogin() {
  if (!token()) location.href = "login.html";
}
ensureLogin();

document.getElementById('logout').onclick = ()=>{ localStorage.removeItem("admin_token"); location.href="login.html"; };

// --- CONFIGURATION MANAGEMENT ---

// Utility function to generate Esign Image inputs
function generateEsignInputs(config) {
    const container = document.getElementById('esign-image-inputs');
    container.innerHTML = '';
    
    for (let i = 1; i <= 5; i++) {
        const key = `esign_image_${i}`;
        const url = config[key];

        container.innerHTML += `
            <form id="esignForm${i}" class="col-span-1 border rounded-lg p-3 bg-gray-50 space-y-2" data-image-number="${i}">
                <label class="text-xs font-semibold block text-gray-700">Image ${i} URL:</label>
                
                <input name="image_url" type="url" value="${url || ''}" class="border rounded px-2 py-1 w-full text-xs" placeholder="Image ${i} Link" required>
                
                <div class="current-image-preview flex justify-between items-center">
                    <img src="${url}" class="mt-1 w-12 h-12 object-cover rounded shadow border" onerror="this.src='https://via.placeholder.com/48/ccc?text=I${i}';" alt="Image ${i} Preview">
                    <button type="submit" class="bg-blue-500 text-white rounded px-2 py-1 text-xs hover:bg-blue-600 transition">Save</button>
                </div>
            </form>
        `;
    }
    attachEsignFormListeners();
}

// Attach event listeners to the dynamically created forms
function attachEsignFormListeners() {
    const esignForms = document.querySelectorAll('[id^="esignForm"]');
    esignForms.forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageNumber = form.dataset.imageNumber;
            const msgDiv = document.getElementById('configMsg');
            
            const fd = new FormData(form); 
            
            msgDiv.textContent = `Saving Image ${imageNumber}...`;
            msgDiv.className = 'text-sm mt-2 font-medium text-blue-600';

            try {
                const res = await fetch(`${API}/config/esign_image/${imageNumber}`, {
                    method: "PUT",
                    headers: { "Authorization": authHeaders().Authorization },
                    body: fd 
                });

                if (res.ok) {
                    msgDiv.textContent = `‚úÖ Esign Image ${imageNumber} Updated!`;
                    loadConfig(); // Reload all configs and update UI
                } else {
                    const errorData = await res.json();
                    msgDiv.textContent = `‚ùå Failed to update Image ${imageNumber}: ${errorData.detail || 'Server error'}`;
                    msgDiv.className = 'text-sm mt-2 font-medium text-red-600';
                }
            } catch (error) {
                msgDiv.textContent = "‚ùå Network Error: Could not reach API.";
                msgDiv.className = 'text-sm mt-2 font-medium text-red-600';
            }
        });
    });
}

// Load all config data on startup
async function loadConfig() {
  const cartDiv = document.getElementById('currentCartConfig');
  cartDiv.innerHTML = 'Loading...';

  try {
    const res = await fetch(API + "/config", { headers: authHeaders() });
    if (res.ok) {
      const data = await res.json();
      
      const cartUrl = data.public_image_url;
      
      document.getElementById('publicImageUrl').value = cartUrl;
      
      cartDiv.innerHTML = `<img src="${cartUrl}" class="mt-1 w-10 h-10 object-cover rounded shadow inline-block"> Current URL: <a href="${cartUrl}" target="_blank" class="text-xs text-indigo-600 hover:underline break-all">${cartUrl}</a>`;
      
      generateEsignInputs(data); 

    } else {
      cartDiv.textContent = 'Failed to load config.';
      generateEsignInputs({}); 
    }
  } catch (error) {
    cartDiv.textContent = 'Network Error: Cannot fetch config from API.';
    generateEsignInputs({});
  }
}

// Save Public Cart Image URL
document.getElementById('configPublicForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const msgDiv = document.getElementById('configMsg');
  const cartUrl = document.getElementById('publicImageUrl').value;
  msgDiv.textContent = "Saving Cart Image...";
  msgDiv.className = 'text-sm mt-2 font-medium text-green-600';
  
  const fd = new FormData();
  fd.append("public_image_url", cartUrl);


  try {
    const res = await fetch(API + "/config/public", {
      method: "PUT",
      headers: { "Authorization": authHeaders().Authorization },
      body: fd
    });

    if (res.ok) {
      msgDiv.textContent = "‚úÖ Public Cart Image URL Updated!";
      loadConfig(); 
      load(); 
    } else {
      msgDiv.textContent = "‚ùå Failed to update config.";
      msgDiv.className = 'text-sm mt-2 font-medium text-red-600';
    }
  } catch (error) {
    msgDiv.textContent = "‚ùå Network Error: Could not reach API.";
    msgDiv.className = 'text-sm mt-2 font-medium text-red-600';
  }
});


// --- ORDER MANAGEMENT (EXISTING LOGIC) ---
document.getElementById('addForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  try {
    const res = await fetch(API + "/orders", { method:"POST", body: fd });
    const msg = document.getElementById('addMsg');
    if (res.ok){ msg.textContent = "‚úÖ Created"; e.target.reset(); load(); } else { msg.textContent = "‚ùå Failed"; }
  } catch (error) {
    document.getElementById('addMsg').textContent = "‚ùå Network Error. Is API running?";
  }
});

async function load(){
  const q = document.getElementById('q').value.trim();
  const st = document.getElementById('status').value;
  const url = new URL(API + "/orders");
  url.searchParams.set("page", page);
  // FIX: If search status is 'backlist', send 'rejected' to the API
  if (st === 'backlist') {
      url.searchParams.set("status", 'rejected');
  } else if (st) {
      url.searchParams.set("status", st);
  }
  
  url.searchParams.set("page_size", pageSize);
  url.searchParams.set("sort", "-id");
  if (q) url.searchParams.set("q", q);
  

  try {
    const res = await fetch(url, { headers: authHeaders() }); 
    const data = await res.json();
    total = data.total;
    document.getElementById('meta').textContent = `${total} items`;
    document.getElementById('pageInfo').textContent = `Page ${data.page}`;

    const tb = document.getElementById('tbody');
    tb.innerHTML = "";
    data.items.forEach(o=>{
      // Map DB status to display status
      const displayStatus = o.status === 'rejected' ? 'backlist' : o.status;
      
      const statusColor = o.status==='approved'?'border-green-500 bg-green-50 text-green-700':'' +
                          (o.status==='pending'?'border-yellow-500 bg-yellow-50 text-yellow-700':'' )+
                          // Apply red color for the 'rejected' DB status, which is displayed as 'backlist'
                          (o.status==='rejected'?'border-red-500 bg-red-50 text-red-700':'');

      tb.innerHTML += `
        <tr class="border-b">
          <td class="p-2">${o.id}</td>
          <td class="p-2"><img src="${API}${o.image_url}" class="w-12 h-12 rounded object-cover" onerror="this.onerror=null;this.src='https://via.placeholder.com/48/ccc?text=No%20Img';"></td>
          <td class="p-2">${o.name}</td>
          <td class="p-2 break-all font-mono text-xs">${o.udid}</td>
          <td class="p-2">
            <span class="px-2 py-0.5 rounded-full border text-xs ${statusColor}">${displayStatus}</span>
          </td>
          <td class="p-2">
             <a href="${o.download_link}" target="_blank" class="text-sm text-blue-600 hover:underline">${o.download_link.length > 5 ? 'Download' : 'Set Link'}</a>
          </td>
          <td class="p-2">
             <a href="view_payment.html?id=${o.id}" target="_blank" class="text-sm text-indigo-600 hover:underline">View Proof</a>
          </td>
          <td class="p-2 text-xs">${new Date(o.created_at).toLocaleString()}</td>
          <td class="p-2 space-x-2 whitespace-nowrap">
            <button class="px-2 py-1 border rounded text-xs hover:bg-gray-100" onclick="openEdit(${o.id})">Edit</button>
            <button class="px-2 py-1 border rounded text-red-600 text-xs hover:bg-red-50" onclick="delItem(${o.id})">Delete</button>
          </td>
        </tr>`;
    });
  } catch (error) {
    document.getElementById('tbody').innerHTML = '<tr><td colspan="9" class="p-4 text-center text-red-600">Error loading orders. Is the API running?</td></tr>';
  }
}
document.getElementById('btnSearch').onclick = ()=>{ page=1; load(); };
document.getElementById('prev').onclick = ()=>{ if(page>1){ page--; load(); } };
document.getElementById('next').onclick = ()=>{
  const maxPage = Math.ceil(total / pageSize) || 1;
  if (page < maxPage){ page++; load(); }
};

// Delete
async function delItem(id){
  if (!confirm("Delete this order?")) return;
  try {
    const res = await fetch(API + "/orders/" + id, { method:"DELETE", headers: authHeaders() });
    if (res.ok) load(); else alert("Delete failed");
  } catch (error) {
    alert("Delete failed due to network error.");
  }
}

// Edit (open modal)
async function openEdit(id){
  try {
    const res = await fetch(API + "/orders/" + id, { headers: authHeaders() });
    const o = await res.json();
    const f = document.getElementById('editForm');
    f.id.value = o.id;
    f.name.value = o.name;
    f.udid.value = o.udid;
    // Map DB status to display status: 'rejected' -> 'backlist'
    f.status.value = o.status === 'rejected' ? 'backlist' : o.status; 
    f.download_link.value = o.download_link === '#' ? '' : o.download_link;
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('modal').classList.add('flex');
    document.getElementById('editMsg').textContent = "";
  } catch (error) {
    alert("Could not fetch order data for editing. Check console for API error.");
  }
}
document.getElementById('closeModal').onclick = ()=>{
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('modal').classList.remove('flex');
  document.getElementById('editMsg').textContent = "";
};
document.getElementById('editForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const id = f.id.value;
  const fd = new FormData();
  
  // Map display status ('backlist') back to DB status ('rejected')
  const finalStatus = f.status.value === 'backlist' ? 'rejected' : f.status.value;
  
  fd.append("name", f.name.value);
  fd.append("udid", f.udid.value);
  fd.append("status", finalStatus); // Send DB value ('rejected' or 'pending' or 'approved')
  fd.append("download_link", f.download_link.value || '#');
  if (f.image.files[0]) fd.append("image", f.image.files[0]);

  const msg = document.getElementById('editMsg');
  
  try {
    const res = await fetch(API + "/orders/" + id, {
      method: "PUT",
      headers: authHeaders(),
      body: fd
    });
    
    if (res.ok){ msg.textContent = "‚úÖ Updated"; load(); }
    else { msg.textContent = "‚ùå Update failed"; }
  } catch (error) {
    msg.textContent = "‚ùå Update failed due to network error.";
  }
});

// Load config and orders on startup
loadConfig();
load();
</script>
</body>
</html>