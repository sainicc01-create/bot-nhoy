<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Order Details - NhoyHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<header class="bg-white border-b sticky top-0 z-10">
  <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="font-bold text-xl">Order Details</h1>
    <a href="index.html" class="text-sm text-indigo-600 hover:underline">← Back to List</a>
  </div>
</header>

<main class="max-w-4xl mx-auto p-4 sm:p-8">
    <div id="loader" class="text-gray-500 text-lg mt-10 text-center">Loading order details...</div>
    <div id="error" class="hidden text-red-600 bg-red-100 p-4 rounded mt-6"></div>
    
    <div id="content" class="hidden bg-white rounded-xl shadow-lg border p-6 space-y-8">
        
        <div class="text-center">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4">Your Esign Product</h2>
            
            <div class="relative w-full max-w-md mx-auto">
                <img id="esign-image" src="https://via.placeholder.com/400x200/cccccc/000000?text=Loading..." alt="Esign Product Image" class="w-full h-auto rounded-lg shadow-xl border-4 border-indigo-200 transition duration-300">
                
                <button id="prev-image" class="absolute top-1/2 left-0 transform -translate-y-1/2 bg-white/70 p-2 rounded-full shadow-lg ml-2 hover:bg-white transition disabled:opacity-50">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button id="next-image" class="absolute top-1/2 right-0 transform -translate-y-1/2 bg-white/70 p-2 rounded-full shadow-lg mr-2 hover:bg-white transition disabled:opacity-50">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <p id="image-counter" class="text-sm text-gray-600 mt-2">Image 1 of 5</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
            
            <div>
                <h3 class="text-xl font-semibold mb-3">Information Summary</h3>
                <div class="space-y-3 text-gray-700">
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-medium">Order Name / Plan:</span>
                        <span id="detail-name" class="font-semibold text-right"></span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-medium">Order Price:</span>
                        <span id="detail-price" class="font-semibold text-right text-green-600"></span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-medium">Submitted Date:</span>
                        <span id="detail-date" class="text-sm text-right"></span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-medium">Status:</span>
                        <span id="detail-status" class="font-bold uppercase"></span>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold mb-3">Device & Installation</h3>
                <div class="space-y-3 text-gray-700">
                    <div class="flex flex-col border-b pb-1">
                        <span class="font-medium">UDID (Device Identifier):</span>
                        <code id="detail-udid" class="break-all bg-gray-100 text-indigo-700 p-2 rounded text-xs font-mono select-all mt-1"></code>
                    </div>
                    <div class="pt-4">
                        <p class="text-sm font-medium text-gray-600 mb-2">Esign Download Access:</p>
                        <a id="detail-download-btn" href="#" target="_blank" class="w-full inline-flex justify-center items-center px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition disabled:bg-gray-400">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Download Esign
                        </a>
                        <p id="download-message" class="text-xs text-red-500 mt-2 hidden">Download link not yet set by Admin.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<script>
const API = "https://nhoy-api.onrender.com";
const FIXED_ADMIN_TOKEN = "admin_token"; 
const defaultPlaceholder = "https://via.placeholder.com/400x200/cccccc/000000?text=No+Image+Set";

let esignImageUrls = [];
let currentImageIndex = 0;

// Fetches the global Esign image URL array from the DB config table
async function getGlobalConfig() {
    try {
        const res = await fetch(API + "/config", { 
            headers: { "Authorization": "Bearer " + FIXED_ADMIN_TOKEN } 
        });
        
        if (res.status === 200) {
            const data = await res.json();
            
            // Collect URLs from esign_image_1 to esign_image_5
            const urls = [];
            for (let i = 1; i <= 5; i++) {
                const url = data[`esign_image_${i}`];
                // Only include URLs that are set and not empty placeholders
                if (url && !url.includes("placeholder.com") && url.trim() !== "") {
                    urls.push(url);
                }
            }
            // Return the array of valid URLs, or the default placeholder if none are set
            return urls.length > 0 ? urls : [defaultPlaceholder];
        }
    } catch (e) {
        console.error("Error fetching Esign config:", e);
    }
    return [defaultPlaceholder];
}

function updateImageDisplay() {
    const imgElement = document.getElementById('esign-image');
    const prevBtn = document.getElementById('prev-image');
    const nextBtn = document.getElementById('next-image');
    const counter = document.getElementById('image-counter');

    if (esignImageUrls.length === 0 || esignImageUrls[0] === defaultPlaceholder) {
        imgElement.src = defaultPlaceholder;
        counter.textContent = "Image Gallery Empty";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
    }

    imgElement.src = esignImageUrls[currentImageIndex];
    counter.textContent = `Image ${currentImageIndex + 1} of ${esignImageUrls.length}`;
    
    prevBtn.disabled = currentImageIndex === 0;
    nextBtn.disabled = currentImageIndex === esignImageUrls.length - 1;
}

document.getElementById('prev-image').onclick = () => {
    if (currentImageIndex > 0) {
        currentImageIndex--;
        updateImageDisplay();
    }
};

document.getElementById('next-image').onclick = () => {
    if (currentImageIndex < esignImageUrls.length - 1) {
        currentImageIndex++;
        updateImageDisplay();
    }
};


async function loadDetails() {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('id');
    const loader = document.getElementById('loader');
    const errorDiv = document.getElementById('error');
    const content = document.getElementById('content');

    if (!orderId) {
        errorDiv.textContent = "❌ Error: Order ID is missing.";
        errorDiv.classList.remove('hidden');
        loader.classList.add('hidden');
        return;
    }

    try {
        // Fetch Order details and Esign Image URLs concurrently
        const [orderRes, urls] = await Promise.all([
            fetch(API + "/orders/" + orderId),
            getGlobalConfig()
        ]);
        
        esignImageUrls = urls; // Store global image array
        
        if (!orderRes.ok) {
            errorDiv.textContent = `❌ Failed to fetch order ${orderId}. Status: ${orderRes.status}.`;
            errorDiv.classList.remove('hidden');
            return;
        }

        const order = await orderRes.json();
        
        // Initialize image carousel with fetched URLs
        updateImageDisplay(); 
        
        // Populate Details
        document.getElementById('detail-name').textContent = order.name;
        document.getElementById('detail-price').textContent = `$${order.price}`;
        document.getElementById('detail-udid').textContent = order.udid;
        document.getElementById('detail-date').textContent = new Date(order.created_at).toLocaleString();

        // Status Logic
        const statusElement = document.getElementById('detail-status');
        let statusColor = 'text-gray-500';
        if (order.status === 'approved') statusColor = 'text-green-600';
        else if (order.status === 'pending') statusColor = 'text-yellow-600';
        else if (order.status === 'rejected') statusColor = 'text-red-600';
        statusElement.className = statusColor + ' font-bold';
        statusElement.textContent = order.status;

        // Download Link Logic (Admin set link)
        const downloadButton = document.getElementById('detail-download-btn');
        const downloadMessage = document.getElementById('download-message');
        const downloadLink = order.download_link;

        if (downloadLink && downloadLink !== '#' && downloadLink !== '') {
            downloadButton.href = downloadLink;
        } else {
            // Disable button and show message if no link is set by admin
            downloadButton.href = "#";
            downloadButton.classList.add('bg-gray-400', 'cursor-not-allowed', 'opacity-75');
            downloadButton.disabled = true;
            downloadMessage.classList.remove('hidden');
        }


        loader.classList.add('hidden');
        content.classList.remove('hidden');

    } catch (e) {
        errorDiv.textContent = '❌ Network Error. Could not load order data. Check console for details.';
        errorDiv.classList.remove('hidden');
    } finally {
        loader.classList.add('hidden');
    }
}

loadDetails();
</script>
</body>
</html>