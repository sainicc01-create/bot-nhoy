<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Order Verification - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .payment-image-container {
        max-height: 70vh; /* Limit the max height of the image container */
        overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
<header class="bg-white border-b shadow-sm sticky top-0 z-10">
  <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="font-bold text-xl text-gray-800">Order Verification Center</h1>
    <a href="admin.html" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">← Back to Admin Panel</a>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 sm:p-8">
    <div id="loader" class="text-gray-500 text-lg mt-10 text-center">
        <svg class="animate-spin h-6 w-6 mr-3 inline-block text-indigo-500" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Loading order details...
    </div>
    <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-6" role="alert"></div>
    
    <div id="content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border p-4 sm:p-6 space-y-4">
            <h3 class="text-xl font-semibold border-b pb-3 text-indigo-600 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 16m-7-2h3"></path></svg>
                Payment Proof Screenshot
            </h3>
            <div class="payment-image-container flex justify-center items-center bg-gray-50 p-4 rounded-lg">
                <img id="payment-image" src="" alt="Payment Screenshot" class="w-full h-auto object-contain rounded-md shadow-md transition duration-300 hover:scale-[1.01]">
            </div>
            <div class="pt-4 flex justify-between items-center border-t">
                <p class="text-sm text-gray-500">File must be verified manually.</p>
                <a id="download-link" href="" download class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download Image
                </a>
            </div>
        </div>

        <div class="lg:col-span-1 bg-white rounded-xl shadow-lg border p-4 sm:p-6 space-y-6">
            
            <div class="space-y-4">
                <h3 class="text-xl font-semibold border-b pb-3 text-gray-800">Order Information</h3>
                
                <div class="flex flex-col">
                    <span class="text-xs font-medium text-gray-500">Order Name / Plan:</span>
                    <span id="order-title" class="text-lg font-bold text-gray-900"></span>
                </div>

                <div class="flex flex-col">
                    <span class="text-xs font-medium text-gray-500">Database ID:</span>
                    <span id="order-id" class="text-sm font-semibold text-gray-700"></span>
                </div>

                <div class="flex flex-col">
                    <span class="text-xs font-medium text-gray-500">UDID (Device ID):</span>
                    <code id="order-udid" class="break-all bg-gray-100 text-indigo-700 p-2 rounded text-xs font-mono select-all"></code>
                </div>
                
                <div class="flex flex-col">
                    <span class="text-xs font-medium text-gray-500">Current Status:</span>
                    <span id="order-status" class="text-lg font-bold"></span>
                </div>
            </div>
            
            <div class="pt-4 border-t space-y-4">
                <h3 class="text-xl font-semibold text-gray-800">Admin Actions</h3>
                <p class="text-sm text-gray-600">To change status, please use the main Admin Panel.</p>
                <a href="admin.html" class="w-full inline-block text-center px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">
                    Go to Edit in Admin Panel
                </a>
            </div>
        </div>
    </div>
</main>

<script>
const API = "http://127.0.0.1:8000";

function token() { return localStorage.getItem("admin_token") || ""; }
function authHeaders() { return { "Authorization": "Bearer " + token() }; }

async function loadPaymentProof() {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('id');
    const loader = document.getElementById('loader');
    const errorDiv = document.getElementById('error');
    const content = document.getElementById('content');

    if (!token()) {
        errorDiv.textContent = "❌ Access Denied. You must be logged in as an Admin to view payment proof.";
        errorDiv.classList.remove('hidden');
        loader.classList.add('hidden');
        return;
    }
    
    if (!orderId) {
        errorDiv.textContent = "❌ Error: Order ID is missing in the URL.";
        errorDiv.classList.remove('hidden');
        loader.classList.add('hidden');
        return;
    }

    try {
        const res = await fetch(API + "/orders/" + orderId, {
            headers: authHeaders()
        });
        
        if (!res.ok) {
            errorDiv.textContent = `❌ Failed to fetch order ${orderId}. Status: ${res.status} ${res.statusText}. Please check API connection.`;
            errorDiv.classList.remove('hidden');
            loader.classList.add('hidden');
            return;
        }

        const order = await res.json();
        
        // Populate Details
        document.getElementById('order-title').textContent = order.name;
        document.getElementById('order-id').textContent = order.id;
        document.getElementById('order-udid').textContent = order.udid;

        // Set status color and text
        const statusElement = document.getElementById('order-status');
        let statusColor = 'text-gray-500';
        if (order.status === 'approved') statusColor = 'text-green-600';
        else if (order.status === 'pending') statusColor = 'text-yellow-600';
        else if (order.status === 'rejected') statusColor = 'text-red-600';

        statusElement.className = statusColor + ' font-bold uppercase';
        statusElement.textContent = order.status;

        // Set Image and Download Link
        const imageUrl = `${API}${order.image_url}`;
        document.getElementById('payment-image').src = imageUrl;
        document.getElementById('download-link').href = imageUrl;

        loader.classList.add('hidden');
        content.classList.remove('hidden');

    } catch (e) {
        errorDiv.textContent = '❌ Network Error. Could not connect to the API.';
        errorDiv.classList.remove('hidden');
    } finally {
        loader.classList.add('hidden');
    }
}

loadPaymentProof();
</script>
</body>
</html>